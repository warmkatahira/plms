import audio_play from '../../audio';
import playNumberSound from '../../number_audio';
import start_loading from '../../loading';

// 画面読み込み時の処理
$(document).ready(function() {
    // 受注管理IDにフォーカス
    $('#order_control_id').focus();
});

// 受注管理IDが変更されたら
$('#order_control_id').on("change",function(){
    // 受注管理IDに値がある場合のみ処理する
    if($('#order_control_id').val()){
        const ajax_url = '/shipping_inspection/ajax_check_order_control_id';
        $.ajax({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            },
            url: ajax_url,
            type: 'POST',
            data: {
                order_control_id: $('#order_control_id').val(),
            },
            dataType: 'json',
            success: function(data){
                try {
                    // エラーがある場合
                    if(data['error_message']){
                        // 受注管理IDをクリアしてフォーカス
                        $('#order_control_id').val(null);
                        $('#order_control_id').focus();
                        // エラーを返す
                        throw new Error(data['error_message']);
                    }
                    // 受注管理IDをロックして背景をグレーに
                    $('#order_control_id').prop("disabled", true);
                    $('#order_control_id').addClass('bg-gray-200');
                    // 配送伝票番号にフォーカスして、メッセージをクリア
                    $('#tracking_no').focus();
                    $('#message').html(null);
                    audio_play('proc');
                } catch (e) {
                    audio_play('ng');
                    // エラーをメッセージに出力
                    $('#message').html(e.message);
                }
            },
            error: function(){
                alert('失敗');
            }
        });
    }
});

// 配送伝票番号が変更されたら
$('#tracking_no').on("change",function(){
    // 配送伝票番号に値がある場合のみ処理する
    if($('#tracking_no').val()){
        const ajax_url = '/shipping_inspection/ajax_check_tracking_no';
        $.ajax({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            },
            url: ajax_url,
            type: 'POST',
            data: {
                order_control_id: $('#order_control_id').val(),
                tracking_no: $('#tracking_no').val(),
            },
            dataType: 'json',
            success: function(data){
                try {
                    // エラーがある場合
                    if(data['error_message']){
                        // 配送伝票番号をクリアしてフォーカス
                        $('#tracking_no').val(null);
                        $('#tracking_no').focus();
                        // エラーを返す
                        throw new Error(data['error_message']);
                    }
                    // 配送伝票番号をロックして背景をグレーに
                    $('#tracking_no').prop("disabled", true);
                    $('#tracking_no').addClass('bg-gray-200');
                    // 商品識別コードにフォーカスして、メッセージをクリア
                    set_item_id_code();
                    $('#message').html(null);
                    // 検品対象一覧に検品情報をセット
                    inspection_target_table_set(data['inspection_targets']);
                    // 残PCSをセット
                    set_remaining_pcs();
                    // 検品対象が存在しない場合
                    if(data['inspection_targets'].length === 0){
                        // 出荷検品完了処理
                        inspection_complete();
                    }
                    playNumberSound(data['total_ship_quantity']);
                } catch (e) {
                    audio_play('ng');
                    // エラーをメッセージに出力
                    $('#message').html(e.message);
                }
            },
            error: function(){
                alert('失敗');
            }
        });
    }
});

// 検品対象一覧に検品情報をセット
function inspection_target_table_set(inspection_targets){
    // レコード分だけループ処理
    for(let inspection_target of inspection_targets){
        // 新しい行を作成
        let newRow = $("<tr id='" + inspection_target['item_id'] + "' class='text-left hover:bg-theme-sub cursor-default whitespace-nowrap'>");
        // 新しい行にセルを追加
        newRow.append($("<td class='py-1 px-2 border'>").text(inspection_target['item_jan_code']));
        newRow.append($("<td class='py-1 px-2 border'>").text(inspection_target['item_name']));
        newRow.append($("<td class='ship_quantity py-1 px-2 border text-right'>").text(inspection_target['total_ship_quantity']));
        newRow.append($("<td class='inspection_quantity py-1 px-2 border text-right'>").text(0));
        // テーブルの末尾に新しい行を追加
        $('#inspection_target_table').append(newRow);
    }
}

// 商品識別コードが変更されたら
$('#item_id_code').on("change",function(){
    // 商品識別コードに値がある場合のみ処理する
    if($('#item_id_code').val()){
        const ajax_url = '/shipping_inspection/ajax_check_item_id_code';
        $.ajax({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            },
            url: ajax_url,
            type: 'POST',
            data: {
                order_control_id: $('#order_control_id').val(),
                item_id_code: $('#item_id_code').val(),
            },
            dataType: 'json',
            success: function(data){
                console.log(data['progress']);
                try {
                    // エラーがある場合
                    if(data['error_info']){
                        // エラーを返す
                        throw data.error_info;
                    }
                    // 検品数がカウントアップされていたら
                    if(data['inspection']){
                        set_item_id_code();
                        // メッセージをクリア
                        $('#message').html(null);
                        // 検品数を更新する
                        $('#' + data['item_id'] + ' .inspection_quantity').text(data['inspection_quantity']);
                        // 残PCSをセット
                        set_remaining_pcs();
                        // 検品が完了していたら、検品対象一覧から検品完了一覧に移動
                        if(data['inspection_complete']){
                            $('#' + data['item_id']).appendTo($('#inspection_complete_table'));
                        }
                        // 全ての商品の検品が完了している場合
                        if(data['inspection_complete_order']){
                            // 出荷検品完了処理
                            inspection_complete();
                        }
                        audio_play('proc');
                    }
                } catch (e) {
                    audio_play('ng');
                    // モーダルを開く
                    $('#item_id_code_alert_modal').removeClass('hidden');
                    // エラーをメッセージに出力
                    $('#error_message').html(e.message);
                    $('#error_item_id_code').html(e.item_id_code);
                    $('#error_item_name').html(e.item_name);
                    $('#error_item_image').attr('src','/storage/item_images/' + e.item_image_file_name);
                    // この要素にフォーカスをあてて、モーダル表示中にスキャンが進まないようにしている
                    $('#item_id_code_alert_modal_focus_element').focus();
                }
            },
            error: function(){
                alert('失敗');
            }
        });
    }
});

// モーダル表示中にフォーカスがあたる要素が変更されたら
$('#item_id_code_alert_modal_focus_element').on("change",function(){
    audio_play('ng');
    $('#item_id_code_alert_modal_focus_element').val(null);
    $('#item_id_code_alert_modal_focus_element').focus();
});

const fixedFocusElement = $('#item_id_code_alert_modal_focus_element');

// フォーカスを強制的に固定する
fixedFocusElement.on('blur', function () {
    setTimeout(() => {
        fixedFocusElement.focus();
    }, 0); // フォーカスが外れた瞬間に再フォーカス
});

// 商品識別コードをクリアしてフォーカス
function set_item_id_code(){
    $('#item_id_code').val(null);
    $('#item_id_code').focus();
    return;
}

// 残PCSをセット
function set_remaining_pcs(){
    // 出荷数と検品数の合計を取得
    let total_ship_quantity = 0;
    let total_inspection_quantity = 0;
    $('.ship_quantity').each(function(){
        total_ship_quantity += parseInt($(this).text());
    });
    $('.inspection_quantity').each(function(){
        total_inspection_quantity += parseInt($(this).text());
    });
    // 残PCSをセット
    $('#remaining_pcs').html(total_ship_quantity - total_inspection_quantity);
    return;
}

// クリックイベント
$(document).on('click', function(e) {
    // クリックされた要素にモーダルを閉じるクラス名が設定されていれば、モーダルを閉じる
    if(e.target.classList.contains('item_id_code_alert_modal_close') == true){
        // モーダルを閉じる
        $('#item_id_code_alert_modal').addClass('hidden');
        set_item_id_code();
    }
});

// 出荷検品完了処理
function inspection_complete(){
    start_loading();
    // 商品識別コードをロックして背景をグレーに
    $('#item_id_code').prop("disabled", true);
    $('#item_id_code').addClass('bg-gray-200');
    // 完了音を再生(完了音の再生が終了したら中の処理を実施)
    audio_play('complete', function () {
        $('#order_control_id').prop("disabled", false);
        $('#shipping_inspection_form').submit();
    });
}